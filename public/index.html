<style>
canvas {
  transform: rotate(180deg);
}
</style>
<h2>Pushy Turk</h2>

<p>Controls:</p>
<div id="buttons">
  <button id="left">&larr;</button>
  <button id="right">&rarr;</button>
  <button id="up">&uarr;</button>
  <button id="down">&darr;</button>
  <button id="brake">.</button>
</div>
<p>World view:</p>
<canvas id="worldView" width="400" height="400" style="border:1px solid #000000;"></canvas>

<p>Chat:</p>
<form id="form" onsubmit="return send()">
  <input id="input" type="text" name="input">
  <input type="submit" value="Send">
</form>
<br/>

<div id="messages">Connecting...</div>

<script>
  
const messageEl = document.querySelector('#messages');
const inputEl = document.querySelector('#input');
const leftEl = document.querySelector('#left');
const rightEl = document.querySelector('#right');
const downEl = document.querySelector('#down');
const upEl = document.querySelector('#up');
const brakeEl = document.querySelector('#brake');
const worldEl = document.querySelector('#worldView');
  
var worldView = worldEl.getContext("2d");
// worldView.scale(3, 3);
// worldView.font = "20px Arial";
// worldView.fillText("Waiting for world info...", 10, 30);
    
const wsProtocol = window.location.protocol == "https:" ? "wss" : "ws";  
const url = `${wsProtocol}://${window.location.hostname}:${window.location.port}/driver`;
console.log(`Connecting to: ${url}`);
const connection = new WebSocket(url);
    
connection.onopen = function() {
  messageEl.innerText = 'Websocket connected!';
};
  
connection.onerror = function(e) {
  messageEl.innerText = 'Error!';
};
  
let static = {};
 
connection.onmessage = function(message) {
  const data = JSON.parse(message.data);
  if(data.message) { 
    messageEl.innerHTML = '<br/>' + messageEl.innerHTML; 
    messageEl.prepend('Client ' + data.cid + ': ' + data.message);
  }
  if(data.actions) {
    messageEl.innerHTML = '<br/>' + messageEl.innerHTML; 
    messageEl.prepend('Client ' + data.cid + ': ' + data.actions);
  }
  else if(data.static) {
    console.log(data.static);
    static = data.static;
    worldView.clearRect(0, 0, worldEl.width, worldEl.height);
    drawObjects(static);
  }
  else if(data.dynamic) {
    worldView.clearRect(0, 0, worldEl.width, worldEl.height);
    drawObjects(static);
    drawObjects(data.dynamic);
  }
};
  
function drawObjects(objects) {
  const xOffset = 150;
    const yOffset = 200;
    const mult = 4;
    objects.forEach(ob => {
    if(ob.type === 'zone') {
      worldView.fillStyle = 'red';
      worldView.fillRect(ob.position.x * mult + xOffset - (ob.size.x * mult / 2), ob.position.z * mult - (ob.size.z * mult / 2) + yOffset, ob.size.x * mult, ob.size.z * mult);
    }
    if(ob.type === 'box') {
      worldView.fillStyle = 'green';
      worldView.fillRect(ob.position.x * mult + xOffset, ob.position.z * mult + yOffset, 2 * mult, 2 * mult);
    }
    if(ob.type === 'kart') {
      worldView.fillStyle = 'blue';
      // worldView.fillRect(ob.position.x * mult + xOffset, ob.position.z * mult + yOffset, 2 * mult, 4 * mult);
      worldView.beginPath();
      worldView.arc(ob.position.x * mult + xOffset, ob.position.z * mult + yOffset, 10, 0, 2 * Math.PI);
      worldView.fill();
    }
  });
}

function send() {
  if(inputEl.value.trim().length < 1)
    return false;
  const message = { message: inputEl.value };
  connection.send(JSON.stringify(message));
  inputEl.value = '';
  return false;
}
  
leftEl.onclick = () => {
  connection.send(JSON.stringify({ event: 'action', actions: ['FORWARD', 'LEFT'] }));
}
rightEl.onclick = () => {
  connection.send(JSON.stringify({ event: 'action', actions: ['FORWARD', 'RIGHT'] }));
}
upEl.onclick = () => {
  connection.send(JSON.stringify({ event: 'action', actions: ['FORWARD'] }));
}
downEl.onclick = () => {
  connection.send(JSON.stringify({ event: 'action', actions: ['BACKWARD'] }));
}
brakeEl.onclick = () => {
  connection.send(JSON.stringify({ event: 'action', actions: ['BRAKE'] }));
}
  
</script>